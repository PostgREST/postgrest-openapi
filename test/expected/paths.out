-- shows root path for the OpenAPI output
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/');
                         jsonb_pretty                         
--------------------------------------------------------------
 {                                                           +
     "get": {                                                +
         "tags": [                                           +
             "Introspection"                                 +
         ],                                                  +
         "responses": {                                      +
             "200": {                                        +
                 "content": {                                +
                     "application/json": {                   +
                         "schema": {                         +
                             "type": "object"                +
                         }                                   +
                     },                                      +
                     "application/openapi+json": {           +
                         "schema": {                         +
                             "type": "object"                +
                         }                                   +
                     }                                       +
                 },                                          +
                 "description": "OK"                         +
             }                                               +
         },                                                  +
         "description": "OpenAPI description (this document)"+
     }                                                       +
 }
(1 row)

-- Tables
-- GET operation object
-- shows the table name as tag
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'get'->'tags');
  jsonb_pretty  
----------------
 [             +
     "products"+
 ]
(1 row)

-- uses a reference for the 200 HTTP code response
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'get'->'responses'->'200');
                      jsonb_pretty                       
---------------------------------------------------------
 {                                                      +
     "$ref": "#/components/responses/notEmpty.products",+
     "description": "OK"                                +
 }
(1 row)

-- uses a reference for the 206 HTTP code response
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'get'->'responses'->'206');
                      jsonb_pretty                       
---------------------------------------------------------
 {                                                      +
     "$ref": "#/components/responses/notEmpty.products",+
     "description": "Partial Content"                   +
 }
(1 row)

-- uses a reference for error responses
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'get'->'responses'->'default');
                    jsonb_pretty                    
----------------------------------------------------
 {                                                 +
     "$ref": "#/components/responses/defaultError",+
     "description": "Error"                        +
 }
(1 row)

-- uses references for columns as query parameters
select value
from jsonb_array_elements(get_openapi_document('{test}')->'paths'->'/products'->'get'->'parameters')
where value->>'$ref' like '#/components/parameters/rowFilter.products.%';
                               value                                
--------------------------------------------------------------------
 {"$ref": "#/components/parameters/rowFilter.products.id"}
 {"$ref": "#/components/parameters/rowFilter.products.code"}
 {"$ref": "#/components/parameters/rowFilter.products.name"}
 {"$ref": "#/components/parameters/rowFilter.products.description"}
 {"$ref": "#/components/parameters/rowFilter.products.attr"}
 {"$ref": "#/components/parameters/rowFilter.products.size"}
(6 rows)

-- shows the first line of the comment on the table as summary
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'get'->'summary');
    jsonb_pretty    
--------------------
 "Products summary"
(1 row)

-- shows the second line of the comment on the table as description
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'get'->'description');
                    jsonb_pretty                     
-----------------------------------------------------
 "Products description\nthat spans\nmultiple lines."
(1 row)

-- uses references for common parameters
select value
from jsonb_array_elements(get_openapi_document('{test}')->'paths'->'/products'->'get'->'parameters')
where value->>'$ref' not like '#/components/parameters/rowFilter.products.%';
                     value                     
-----------------------------------------------
 {"$ref": "#/components/parameters/select"}
 {"$ref": "#/components/parameters/order"}
 {"$ref": "#/components/parameters/limit"}
 {"$ref": "#/components/parameters/offset"}
 {"$ref": "#/components/parameters/or"}
 {"$ref": "#/components/parameters/and"}
 {"$ref": "#/components/parameters/not.or"}
 {"$ref": "#/components/parameters/not.and"}
 {"$ref": "#/components/parameters/range"}
 {"$ref": "#/components/parameters/preferGet"}
(10 rows)

-- POST operation object
-- shows the table name as tag
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'post'->'tags');
  jsonb_pretty  
----------------
 [             +
     "products"+
 ]
(1 row)

-- uses a reference for the 201 HTTP code response
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'post'->'responses'->'201');
                       jsonb_pretty                        
-----------------------------------------------------------
 {                                                        +
     "$ref": "#/components/responses/mayBeEmpty.products",+
     "description": "Created"                             +
 }
(1 row)

-- uses a reference for error responses
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'post'->'responses'->'default');
                    jsonb_pretty                    
----------------------------------------------------
 {                                                 +
     "$ref": "#/components/responses/defaultError",+
     "description": "Error"                        +
 }
(1 row)

-- uses a reference for request body
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'post'->'requestBody'->'$ref');
             jsonb_pretty              
---------------------------------------
 "#/components/requestBodies/products"
(1 row)

-- shows the first line of the comment on the table as summary
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'post'->'summary');
    jsonb_pretty    
--------------------
 "Products summary"
(1 row)

-- shows the second line of the comment on the table as description
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'post'->'description');
                    jsonb_pretty                     
-----------------------------------------------------
 "Products description\nthat spans\nmultiple lines."
(1 row)

-- uses references for common parameters
select value
from jsonb_array_elements(get_openapi_document('{test}')->'paths'->'/products'->'post'->'parameters')
where value->>'$ref' like '#/components/parameters/%';
                     value                      
------------------------------------------------
 {"$ref": "#/components/parameters/select"}
 {"$ref": "#/components/parameters/columns"}
 {"$ref": "#/components/parameters/preferPost"}
(3 rows)

-- PATCH operation object
-- shows the table name as tag
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'patch'->'tags');
  jsonb_pretty  
----------------
 [             +
     "products"+
 ]
(1 row)

-- uses a reference for the 200 HTTP code response
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'patch'->'responses'->'200');
                      jsonb_pretty                       
---------------------------------------------------------
 {                                                      +
     "$ref": "#/components/responses/notEmpty.products",+
     "description": "OK"                                +
 }
(1 row)

-- uses a reference for the 204 HTTP code response
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'patch'->'responses'->'204');
                jsonb_pretty                 
---------------------------------------------
 {                                          +
     "$ref": "#/components/responses/empty",+
     "description": "No Content"            +
 }
(1 row)

-- uses a reference for error responses
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'patch'->'responses'->'default');
                    jsonb_pretty                    
----------------------------------------------------
 {                                                 +
     "$ref": "#/components/responses/defaultError",+
     "description": "Error"                        +
 }
(1 row)

-- uses a reference for request body
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'patch'->'requestBody'->'$ref');
             jsonb_pretty              
---------------------------------------
 "#/components/requestBodies/products"
(1 row)

-- shows the first line of the comment on the table as summary
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'patch'->'summary');
    jsonb_pretty    
--------------------
 "Products summary"
(1 row)

-- shows the second line of the comment on the table as description
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'patch'->'description');
                    jsonb_pretty                     
-----------------------------------------------------
 "Products description\nthat spans\nmultiple lines."
(1 row)

-- uses references for columns as query parameters
select value
from jsonb_array_elements(get_openapi_document('{test}')->'paths'->'/products'->'patch'->'parameters')
where value->>'$ref' like '#/components/parameters/rowFilter.products.%';
                               value                                
--------------------------------------------------------------------
 {"$ref": "#/components/parameters/rowFilter.products.id"}
 {"$ref": "#/components/parameters/rowFilter.products.code"}
 {"$ref": "#/components/parameters/rowFilter.products.name"}
 {"$ref": "#/components/parameters/rowFilter.products.description"}
 {"$ref": "#/components/parameters/rowFilter.products.attr"}
 {"$ref": "#/components/parameters/rowFilter.products.size"}
(6 rows)

-- uses references for common parameters
select value
from jsonb_array_elements(get_openapi_document('{test}')->'paths'->'/products'->'patch'->'parameters')
where value->>'$ref' not like '#/components/parameters/rowFilter.products.%';
                      value                      
-------------------------------------------------
 {"$ref": "#/components/parameters/select"}
 {"$ref": "#/components/parameters/columns"}
 {"$ref": "#/components/parameters/order"}
 {"$ref": "#/components/parameters/limit"}
 {"$ref": "#/components/parameters/or"}
 {"$ref": "#/components/parameters/and"}
 {"$ref": "#/components/parameters/not.or"}
 {"$ref": "#/components/parameters/not.and"}
 {"$ref": "#/components/parameters/preferPatch"}
(9 rows)

-- DELETE operation object
-- shows the table name as tag
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'delete'->'tags');
  jsonb_pretty  
----------------
 [             +
     "products"+
 ]
(1 row)

-- uses a reference for the 200 HTTP code response
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'delete'->'responses'->'200');
                      jsonb_pretty                       
---------------------------------------------------------
 {                                                      +
     "$ref": "#/components/responses/notEmpty.products",+
     "description": "OK"                                +
 }
(1 row)

-- uses a reference for the 204 HTTP code response
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'delete'->'responses'->'204');
                jsonb_pretty                 
---------------------------------------------
 {                                          +
     "$ref": "#/components/responses/empty",+
     "description": "No Content"            +
 }
(1 row)

-- uses a reference for error responses
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'delete'->'responses'->'default');
                    jsonb_pretty                    
----------------------------------------------------
 {                                                 +
     "$ref": "#/components/responses/defaultError",+
     "description": "Error"                        +
 }
(1 row)

-- shows the first line of the comment on the table as summary
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'delete'->'summary');
    jsonb_pretty    
--------------------
 "Products summary"
(1 row)

-- shows the second line of the comment on the table as description
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/products'->'delete'->'description');
                    jsonb_pretty                     
-----------------------------------------------------
 "Products description\nthat spans\nmultiple lines."
(1 row)

-- uses references for columns as query parameters
select value
from jsonb_array_elements(get_openapi_document('{test}')->'paths'->'/products'->'delete'->'parameters')
where value->>'$ref' like '#/components/parameters/rowFilter.products.%';
                               value                                
--------------------------------------------------------------------
 {"$ref": "#/components/parameters/rowFilter.products.id"}
 {"$ref": "#/components/parameters/rowFilter.products.code"}
 {"$ref": "#/components/parameters/rowFilter.products.name"}
 {"$ref": "#/components/parameters/rowFilter.products.description"}
 {"$ref": "#/components/parameters/rowFilter.products.attr"}
 {"$ref": "#/components/parameters/rowFilter.products.size"}
(6 rows)

-- uses references for common parameters
select value
from jsonb_array_elements(get_openapi_document('{test}')->'paths'->'/products'->'delete'->'parameters')
where value->>'$ref' not like '#/components/parameters/rowFilter.products.%';
                      value                       
--------------------------------------------------
 {"$ref": "#/components/parameters/select"}
 {"$ref": "#/components/parameters/order"}
 {"$ref": "#/components/parameters/limit"}
 {"$ref": "#/components/parameters/or"}
 {"$ref": "#/components/parameters/and"}
 {"$ref": "#/components/parameters/not.or"}
 {"$ref": "#/components/parameters/not.and"}
 {"$ref": "#/components/parameters/preferDelete"}
(8 rows)

-- Views
-- GET operation object
-- shows the table name as tag
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'get'->'tags');
    jsonb_pretty    
--------------------
 [                 +
     "big_products"+
 ]
(1 row)

-- uses a reference for the 200 HTTP code response
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'get'->'responses'->'200');
                        jsonb_pretty                         
-------------------------------------------------------------
 {                                                          +
     "$ref": "#/components/responses/notEmpty.big_products",+
     "description": "OK"                                    +
 }
(1 row)

-- uses a reference for the 206 HTTP code response
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'get'->'responses'->'206');
                        jsonb_pretty                         
-------------------------------------------------------------
 {                                                          +
     "$ref": "#/components/responses/notEmpty.big_products",+
     "description": "Partial Content"                       +
 }
(1 row)

-- uses a reference for error responses
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'get'->'responses'->'default');
                    jsonb_pretty                    
----------------------------------------------------
 {                                                 +
     "$ref": "#/components/responses/defaultError",+
     "description": "Error"                        +
 }
(1 row)

-- shows the first line of the comment on the table as summary
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'get'->'summary');
      jsonb_pretty      
------------------------
 "Big products summary"
(1 row)

-- shows the second line of the comment on the table as description
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'get'->'description');
                      jsonb_pretty                       
---------------------------------------------------------
 "Big products description\nthat spans\nmultiple lines."
(1 row)

-- uses references for columns as query parameters
select value
from jsonb_array_elements(get_openapi_document('{test}')->'paths'->'/big_products'->'get'->'parameters')
where value->>'$ref' like '#/components/parameters/rowFilter.big_products.%';
                              value                              
-----------------------------------------------------------------
 {"$ref": "#/components/parameters/rowFilter.big_products.id"}
 {"$ref": "#/components/parameters/rowFilter.big_products.code"}
 {"$ref": "#/components/parameters/rowFilter.big_products.name"}
 {"$ref": "#/components/parameters/rowFilter.big_products.size"}
(4 rows)

-- uses references for common parameters
select value
from jsonb_array_elements(get_openapi_document('{test}')->'paths'->'/big_products'->'get'->'parameters')
where value->>'$ref' not like '#/components/parameters/rowFilter.big_products.%';
                     value                     
-----------------------------------------------
 {"$ref": "#/components/parameters/select"}
 {"$ref": "#/components/parameters/order"}
 {"$ref": "#/components/parameters/limit"}
 {"$ref": "#/components/parameters/offset"}
 {"$ref": "#/components/parameters/or"}
 {"$ref": "#/components/parameters/and"}
 {"$ref": "#/components/parameters/not.or"}
 {"$ref": "#/components/parameters/not.and"}
 {"$ref": "#/components/parameters/range"}
 {"$ref": "#/components/parameters/preferGet"}
(10 rows)

-- shows a GET operation object for non auto-updatable views
select get_openapi_document('{test}')->'paths'->'/non_auto_updatable' ? 'get' as value;
 value 
-------
 t
(1 row)

-- POST operation object
-- shows the table name as tag
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'post'->'tags');
    jsonb_pretty    
--------------------
 [                 +
     "big_products"+
 ]
(1 row)

-- uses a reference for the 201 HTTP code response
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'post'->'responses'->'201');
                         jsonb_pretty                          
---------------------------------------------------------------
 {                                                            +
     "$ref": "#/components/responses/mayBeEmpty.big_products",+
     "description": "Created"                                 +
 }
(1 row)

-- uses a reference for error responses
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'post'->'responses'->'default');
                    jsonb_pretty                    
----------------------------------------------------
 {                                                 +
     "$ref": "#/components/responses/defaultError",+
     "description": "Error"                        +
 }
(1 row)

-- uses a reference for request body
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'post'->'requestBody'->'$ref');
               jsonb_pretty                
-------------------------------------------
 "#/components/requestBodies/big_products"
(1 row)

-- shows the first line of the comment on the table as summary
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'post'->'summary');
      jsonb_pretty      
------------------------
 "Big products summary"
(1 row)

-- shows the second line of the comment on the table as description
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'post'->'description');
                      jsonb_pretty                       
---------------------------------------------------------
 "Big products description\nthat spans\nmultiple lines."
(1 row)

-- uses references for common parameters
select value
from jsonb_array_elements(get_openapi_document('{test}')->'paths'->'/big_products'->'post'->'parameters')
where value->>'$ref' like '#/components/parameters/%';
                     value                      
------------------------------------------------
 {"$ref": "#/components/parameters/select"}
 {"$ref": "#/components/parameters/columns"}
 {"$ref": "#/components/parameters/preferPost"}
(3 rows)

-- does not show a POST operation object for non auto-updatable views
select get_openapi_document('{test}')->'paths'->'/non_auto_updatable' ? 'post' as value;
 value 
-------
 f
(1 row)

-- PATCH operation object
-- shows the table name as tag
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'patch'->'tags');
    jsonb_pretty    
--------------------
 [                 +
     "big_products"+
 ]
(1 row)

-- uses a reference for the 200 HTTP code response
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'patch'->'responses'->'200');
                        jsonb_pretty                         
-------------------------------------------------------------
 {                                                          +
     "$ref": "#/components/responses/notEmpty.big_products",+
     "description": "OK"                                    +
 }
(1 row)

-- uses a reference for the 204 HTTP code response
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'patch'->'responses'->'204');
                jsonb_pretty                 
---------------------------------------------
 {                                          +
     "$ref": "#/components/responses/empty",+
     "description": "No Content"            +
 }
(1 row)

-- uses a reference for error responses
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'patch'->'responses'->'default');
                    jsonb_pretty                    
----------------------------------------------------
 {                                                 +
     "$ref": "#/components/responses/defaultError",+
     "description": "Error"                        +
 }
(1 row)

-- uses a reference for request body
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'patch'->'requestBody'->'$ref');
               jsonb_pretty                
-------------------------------------------
 "#/components/requestBodies/big_products"
(1 row)

-- shows the first line of the comment on the table as summary
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'patch'->'summary');
      jsonb_pretty      
------------------------
 "Big products summary"
(1 row)

-- shows the second line of the comment on the table as description
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'patch'->'description');
                      jsonb_pretty                       
---------------------------------------------------------
 "Big products description\nthat spans\nmultiple lines."
(1 row)

-- uses references for columns as query parameters
select value
from jsonb_array_elements(get_openapi_document('{test}')->'paths'->'/big_products'->'patch'->'parameters')
where value->>'$ref' like '#/components/parameters/rowFilter.big_products.%';
                              value                              
-----------------------------------------------------------------
 {"$ref": "#/components/parameters/rowFilter.big_products.id"}
 {"$ref": "#/components/parameters/rowFilter.big_products.code"}
 {"$ref": "#/components/parameters/rowFilter.big_products.name"}
 {"$ref": "#/components/parameters/rowFilter.big_products.size"}
(4 rows)

-- uses references for common parameters
select value
from jsonb_array_elements(get_openapi_document('{test}')->'paths'->'/big_products'->'patch'->'parameters')
where value->>'$ref' not like '#/components/parameters/rowFilter.big_products.%';
                      value                      
-------------------------------------------------
 {"$ref": "#/components/parameters/select"}
 {"$ref": "#/components/parameters/columns"}
 {"$ref": "#/components/parameters/order"}
 {"$ref": "#/components/parameters/limit"}
 {"$ref": "#/components/parameters/or"}
 {"$ref": "#/components/parameters/and"}
 {"$ref": "#/components/parameters/not.or"}
 {"$ref": "#/components/parameters/not.and"}
 {"$ref": "#/components/parameters/preferPatch"}
(9 rows)

-- does not show a PATCH operation object for non auto-updatable views
select get_openapi_document('{test}')->'paths'->'/non_auto_updatable' ? 'patch' as value;
 value 
-------
 f
(1 row)

-- DELETE operation object
-- shows the table name as tag
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'delete'->'tags');
    jsonb_pretty    
--------------------
 [                 +
     "big_products"+
 ]
(1 row)

-- uses a reference for the 200 HTTP code response
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'delete'->'responses'->'200');
                        jsonb_pretty                         
-------------------------------------------------------------
 {                                                          +
     "$ref": "#/components/responses/notEmpty.big_products",+
     "description": "OK"                                    +
 }
(1 row)

-- uses a reference for the 204 HTTP code response
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'delete'->'responses'->'204');
                jsonb_pretty                 
---------------------------------------------
 {                                          +
     "$ref": "#/components/responses/empty",+
     "description": "No Content"            +
 }
(1 row)

-- uses a reference for error responses
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'delete'->'responses'->'default');
                    jsonb_pretty                    
----------------------------------------------------
 {                                                 +
     "$ref": "#/components/responses/defaultError",+
     "description": "Error"                        +
 }
(1 row)

-- shows the first line of the comment on the table as summary
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'delete'->'summary');
      jsonb_pretty      
------------------------
 "Big products summary"
(1 row)

-- shows the second line of the comment on the table as description
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/big_products'->'delete'->'description');
                      jsonb_pretty                       
---------------------------------------------------------
 "Big products description\nthat spans\nmultiple lines."
(1 row)

-- uses references for columns as query parameters
select value
from jsonb_array_elements(get_openapi_document('{test}')->'paths'->'/big_products'->'delete'->'parameters')
where value->>'$ref' like '#/components/parameters/rowFilter.big_products.%';
                              value                              
-----------------------------------------------------------------
 {"$ref": "#/components/parameters/rowFilter.big_products.id"}
 {"$ref": "#/components/parameters/rowFilter.big_products.code"}
 {"$ref": "#/components/parameters/rowFilter.big_products.name"}
 {"$ref": "#/components/parameters/rowFilter.big_products.size"}
(4 rows)

-- uses references for common parameters
select value
from jsonb_array_elements(get_openapi_document('{test}')->'paths'->'/big_products'->'delete'->'parameters')
where value->>'$ref' not like '#/components/parameters/rowFilter.big_products.%';
                      value                       
--------------------------------------------------
 {"$ref": "#/components/parameters/select"}
 {"$ref": "#/components/parameters/order"}
 {"$ref": "#/components/parameters/limit"}
 {"$ref": "#/components/parameters/or"}
 {"$ref": "#/components/parameters/and"}
 {"$ref": "#/components/parameters/not.or"}
 {"$ref": "#/components/parameters/not.and"}
 {"$ref": "#/components/parameters/preferDelete"}
(8 rows)

-- does not show a DELETE operation object for non auto-updatable views
select get_openapi_document('{test}')->'paths'->'/non_auto_updatable' ? 'delete' as value;
 value 
-------
 f
(1 row)

-- Functions
-- GET operation object
-- shows the function name as tag
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/rpc/get_products_by_size'->'get'->'tags');
           jsonb_pretty           
----------------------------------
 [                               +
     "(rpc) get_products_by_size"+
 ]
(1 row)

-- uses a reference for the 200 HTTP code response
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/rpc/get_products_by_size'->'get'->'responses'->'200');
                          jsonb_pretty                          
----------------------------------------------------------------
 {                                                             +
     "$ref": "#/components/responses/rpc.get_products_by_size",+
     "description": "OK"                                       +
 }
(1 row)

-- uses a reference for the 206 HTTP code response on `RETURNS SET OF` functions
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/rpc/get_products_by_size'->'get'->'responses'->'206');
                          jsonb_pretty                          
----------------------------------------------------------------
 {                                                             +
     "$ref": "#/components/responses/rpc.get_products_by_size",+
     "description": "Partial Content"                          +
 }
(1 row)

-- uses a reference for error responses
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/rpc/get_products_by_size'->'get'->'responses'->'default');
                    jsonb_pretty                    
----------------------------------------------------
 {                                                 +
     "$ref": "#/components/responses/defaultError",+
     "description": "Error"                        +
 }
(1 row)

-- shows the first line of the comment on the table as summary
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/rpc/get_products_by_size'->'get'->'summary');
          jsonb_pretty          
--------------------------------
 "Get Products By Size summary"
(1 row)

-- shows the second line of the comment on the table as description
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/rpc/get_products_by_size'->'get'->'description');
                          jsonb_pretty                           
-----------------------------------------------------------------
 "Get Products By Size description\nthat spans\nmultiple lines."
(1 row)

-- uses references for common parameters on `RETURNS <composite type>` functions
select value
from jsonb_array_elements(get_openapi_document('{test}')->'paths'->'/rpc/get_attribute'->'get'->'parameters')
where value->>'$ref' not like '#/components/parameters/rpcParam.get_attribute.%';
                     value                     
-----------------------------------------------
 {"$ref": "#/components/parameters/select"}
 {"$ref": "#/components/parameters/order"}
 {"$ref": "#/components/parameters/limit"}
 {"$ref": "#/components/parameters/offset"}
 {"$ref": "#/components/parameters/or"}
 {"$ref": "#/components/parameters/and"}
 {"$ref": "#/components/parameters/not.or"}
 {"$ref": "#/components/parameters/not.and"}
 {"$ref": "#/components/parameters/range"}
 {"$ref": "#/components/parameters/preferGet"}
(10 rows)

-- uses references for common parameters on `RETURNS TABLE` functions
select value
from jsonb_array_elements(get_openapi_document('{test}')->'paths'->'/rpc/returns_table'->'get'->'parameters')
where value->>'$ref' not like '#/components/parameters/rpcParam.returns_table.%';
                     value                     
-----------------------------------------------
 {"$ref": "#/components/parameters/select"}
 {"$ref": "#/components/parameters/order"}
 {"$ref": "#/components/parameters/limit"}
 {"$ref": "#/components/parameters/offset"}
 {"$ref": "#/components/parameters/or"}
 {"$ref": "#/components/parameters/and"}
 {"$ref": "#/components/parameters/not.or"}
 {"$ref": "#/components/parameters/not.and"}
 {"$ref": "#/components/parameters/range"}
 {"$ref": "#/components/parameters/preferGet"}
(10 rows)

-- uses references for common parameters on functions with INOUT/OUT parameters
select value
from jsonb_array_elements(get_openapi_document('{test}')->'paths'->'/rpc/returns_inout_out'->'get'->'parameters')
where value->>'$ref' not like '#/components/parameters/rpcParam.returns_inout_out.%';
                     value                     
-----------------------------------------------
 {"$ref": "#/components/parameters/select"}
 {"$ref": "#/components/parameters/order"}
 {"$ref": "#/components/parameters/limit"}
 {"$ref": "#/components/parameters/offset"}
 {"$ref": "#/components/parameters/or"}
 {"$ref": "#/components/parameters/and"}
 {"$ref": "#/components/parameters/not.or"}
 {"$ref": "#/components/parameters/not.and"}
 {"$ref": "#/components/parameters/range"}
 {"$ref": "#/components/parameters/preferGet"}
(10 rows)

-- does not use a reference for the 206 HTTP code response on functions that do not return `SET OF`
select get_openapi_document('{test}')->'paths'->'/rpc/get_attribute'->'get'->'responses' ? '206' as value;
 value 
-------
 f
(1 row)

-- does not use a reference for common parameters (except for prefer headers) on functions that do not return composite types
select value
from jsonb_array_elements(get_openapi_document('{test}')->'paths'->'/rpc/returns_simple_type'->'get'->'parameters')
where value->>'$ref' not like '#/components/parameters/rpcParam.returns_simple_type.%';
                     value                     
-----------------------------------------------
 {"$ref": "#/components/parameters/preferGet"}
(1 row)

-- shows a function with a single unnamed parameter of accepted types
select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/rpc/single_unnamed_json_param'->'get'->'tags');
             jsonb_pretty              
---------------------------------------
 [                                    +
     "(rpc) single_unnamed_json_param"+
 ]
(1 row)

select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/rpc/single_unnamed_jsonb_param'->'get'->'tags');
              jsonb_pretty              
----------------------------------------
 [                                     +
     "(rpc) single_unnamed_jsonb_param"+
 ]
(1 row)

select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/rpc/single_unnamed_text_param'->'get'->'tags');
             jsonb_pretty              
---------------------------------------
 [                                    +
     "(rpc) single_unnamed_text_param"+
 ]
(1 row)

select jsonb_pretty(get_openapi_document('{test}')->'paths'->'/rpc/single_unnamed_xml_param'->'get'->'tags');
             jsonb_pretty             
--------------------------------------
 [                                   +
     "(rpc) single_unnamed_xml_param"+
 ]
(1 row)

-- does not show a function with a single unnamed parameter of non-accepted types
select get_openapi_document('{test}')->'paths' ? '/rpc/single_unnamed_unrecognized_param' as value;
 value 
-------
 f
(1 row)

-- does not show a function with unnamed parameters
select get_openapi_document('{test}')->'paths' ? '/rpc/unnamed_params' as value;
 value 
-------
 f
(1 row)

-- does not show a function with named and unnamed parameters
select get_openapi_document('{test}')->'paths' ? '/rpc/named_and_unnamed_params' as value;
 value 
-------
 f
(1 row)

